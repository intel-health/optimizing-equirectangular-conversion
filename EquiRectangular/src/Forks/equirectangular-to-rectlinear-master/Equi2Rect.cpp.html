<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=UTF-8">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Consolas';
	font-size: 10pt;
	color: #DCDCCC;
}
.sc0 {
}
.sc2 {
	font-weight: bold;
	font-style: italic;
	color: #7F9F7F;
}
.sc4 {
	color: #8CD0D3;
}
.sc5 {
	font-weight: bold;
	color: #DFC47D;
}
.sc6 {
	color: #CC9393;
}
.sc9 {
	color: #FFCFAF;
}
.sc10 {
	font-weight: bold;
	color: #9F9D6D;
}
.sc11 {
}
.sc16 {
	font-weight: bold;
	color: #CEDF99;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #3F3F3F; "><span class="sc9">#include "Equi2Rect.hpp"
#include &lt;math.h&gt;
#include &lt;chrono&gt;&gt;
</span><span class="sc0">
</span><span class="sc11">Equi2Rect</span><span class="sc10">::</span><span class="sc11">Equi2Rect</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc2">// viewport size
</span><span class="sc0">    </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">width</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1080</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">height</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">540</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// specify viewing direction
</span><span class="sc0">    </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">pan_angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">tilt_angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">roll_angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// create rotation matrix
</span><span class="sc0">    </span><span class="sc11">Rot</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">eul2rotm</span><span class="sc10">(</span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">tilt_angle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">pan_angle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">roll_angle</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// specify focal length of the final pinhole image
</span><span class="sc0">    </span><span class="sc11">focal_length</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">672</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// create camera matrix K
</span><span class="sc0">    </span><span class="sc11">K</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat_</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc4">3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">focal_length</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">width</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0">
         </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">focal_length</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">height</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0">
         </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#ifdef CACHE_ROT_KINV
</span><span class="sc0">    </span><span class="sc11">RotKinv</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rot</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">K</span><span class="sc10">.</span><span class="sc11">inv</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc2">// read src image
</span><span class="sc0">    </span><span class="sc11">img_src</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">imread</span><span class="sc10">(</span><span class="sc6">"C:\\Users\\dpbogia\\source\\repos\\flatten360image\\EquiRectangular\\images\\IMG_20230629_082736_00_095.jpg"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">IMREAD_COLOR</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">empty</span><span class="sc10">())</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">invalid_argument</span><span class="sc10">(</span><span class="sc6">"Error: Could not load image!"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// initialize result image
</span><span class="sc0">    </span><span class="sc11">img_dst</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc10">(</span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">height</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">width</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CV_8UC3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Scalar</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc2">//img_dst_path = "c:\\tmp\\pano_rect.jpg";
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">Equi2Rect</span><span class="sc10">::</span><span class="sc11">save_rectlinear_image</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">-&gt;</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">chrono</span><span class="sc10">::</span><span class="sc11">high_resolution_clock</span><span class="sc10">::</span><span class="sc11">time_point</span><span class="sc0"> </span><span class="sc11">startTime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">chrono</span><span class="sc10">::</span><span class="sc11">high_resolution_clock</span><span class="sc10">::</span><span class="sc11">now</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">iterations</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">iterations</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">pan_angle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc4">360</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">this</span><span class="sc10">-&gt;</span><span class="sc11">bilinear_interpolation</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">chrono</span><span class="sc10">::</span><span class="sc11">high_resolution_clock</span><span class="sc10">::</span><span class="sc11">time_point</span><span class="sc0"> </span><span class="sc11">stopTime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">chrono</span><span class="sc10">::</span><span class="sc11">high_resolution_clock</span><span class="sc10">::</span><span class="sc11">now</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">chrono</span><span class="sc10">::</span><span class="sc11">duration</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">aveDuration</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">std</span><span class="sc10">::</span><span class="sc11">chrono</span><span class="sc10">::</span><span class="sc11">duration</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc11">stopTime</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">startTime</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">iterations</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">printf</span><span class="sc10">(</span><span class="sc6">"Average for %d iterations %12.8fs %12.5fms %12.3fus\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">iterations</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">aveDuration</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">aveDuration</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">1000.0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">aveDuration</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">1000000.0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">imwrite</span><span class="sc10">(</span><span class="sc6">"c:\\tmp\\pano_rect.jpg"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">img_dst</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">Equi2Rect</span><span class="sc10">::</span><span class="sc11">show_rectlinear_image</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">-&gt;</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">namedWindow</span><span class="sc10">(</span><span class="sc6">"projected image"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">WINDOW_AUTOSIZE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">imshow</span><span class="sc10">(</span><span class="sc6">"projected image"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">img_dst</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">waitKey</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">destroyWindow</span><span class="sc10">(</span><span class="sc6">"projected image"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">Equi2Rect</span><span class="sc10">::</span><span class="sc11">eul2rotm</span><span class="sc10">(</span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">rotx</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">roty</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">rotz</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-&gt;</span><span class="sc0"> </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc0"> </span><span class="sc11">R_x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat_</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc4">3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                   </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cos</span><span class="sc10">(</span><span class="sc11">rotx</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">sin</span><span class="sc10">(</span><span class="sc11">rotx</span><span class="sc10">),</span><span class="sc0">
                   </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sin</span><span class="sc10">(</span><span class="sc11">rotx</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">cos</span><span class="sc10">(</span><span class="sc11">rotx</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc0"> </span><span class="sc11">R_y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat_</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc4">3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">cos</span><span class="sc10">(</span><span class="sc11">roty</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sin</span><span class="sc10">(</span><span class="sc11">roty</span><span class="sc10">),</span><span class="sc0">
                   </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                   </span><span class="sc10">-</span><span class="sc11">sin</span><span class="sc10">(</span><span class="sc11">roty</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cos</span><span class="sc10">(</span><span class="sc11">roty</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc0"> </span><span class="sc11">R_z</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat_</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc4">3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">cos</span><span class="sc10">(</span><span class="sc11">rotz</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">sin</span><span class="sc10">(</span><span class="sc11">rotz</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                   </span><span class="sc11">sin</span><span class="sc10">(</span><span class="sc11">rotz</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">cos</span><span class="sc10">(</span><span class="sc11">rotz</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                   </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc0"> </span><span class="sc11">R</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">R_z</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">R_y</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">R_x</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">R</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">Equi2Rect</span><span class="sc10">::</span><span class="sc11">reprojection</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">x_img</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">y_img</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-&gt;</span><span class="sc0"> </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec2d</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc0"> </span><span class="sc11">xyz</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat_</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc4">3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">double</span><span class="sc10">)</span><span class="sc11">x_img</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">double</span><span class="sc10">)</span><span class="sc11">y_img</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#ifdef CACHE_ROT_KINV
</span><span class="sc0">    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc0"> </span><span class="sc11">ray3d</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">RotKinv</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">xyz</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">norm</span><span class="sc10">(</span><span class="sc11">xyz</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc0">    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Mat</span><span class="sc0"> </span><span class="sc11">ray3d</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rot</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">K</span><span class="sc10">.</span><span class="sc11">inv</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">xyz</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">norm</span><span class="sc10">(</span><span class="sc11">xyz</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc2">// get 3d spherical coordinates
</span><span class="sc0">    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">xp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ray3d</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">yp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ray3d</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">zp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ray3d</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">&lt;</span><span class="sc16">double</span><span class="sc10">&gt;(</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// inverse formula for spherical projection, reference Szeliski book "Computer Vision: Algorithms and Applications" p439.
</span><span class="sc0">    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">theta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">atan2</span><span class="sc10">(</span><span class="sc11">yp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sqrt</span><span class="sc10">(</span><span class="sc11">xp</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">xp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">zp</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">zp</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">phi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">atan2</span><span class="sc10">(</span><span class="sc11">xp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">zp</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// get 2D point on equirectangular map
</span><span class="sc0">    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">x_sphere</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">phi</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">cols</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">M_PI</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">cols</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">y_sphere</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">theta</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">M_PI</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">rows</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">M_PI</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec2d</span><span class="sc10">(</span><span class="sc11">x_sphere</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">y_sphere</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">auto</span><span class="sc0"> </span><span class="sc11">Equi2Rect</span><span class="sc10">::</span><span class="sc11">bilinear_interpolation</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">-&gt;</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec2d</span><span class="sc0"> </span><span class="sc11">current_pos</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// variables for bilinear interpolation
</span><span class="sc0">    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">top_left_x</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">top_left_y</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dy</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">wtl</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">wtr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">wbl</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">wbr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec3b</span><span class="sc0"> </span><span class="sc11">value</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bgr</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// loop over every pixel in output rectlinear image
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">v</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">v</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">height</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">v</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">u</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">u</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">viewport</span><span class="sc10">.</span><span class="sc11">width</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">++</span><span class="sc11">u</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">

            </span><span class="sc2">// determine corresponding position in the equirectangular panorama
</span><span class="sc0">            </span><span class="sc11">current_pos</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">reprojection</span><span class="sc10">(</span><span class="sc11">u</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">v</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc2">// determine the nearest top left pixel for bilinear interpolation
</span><span class="sc0">            </span><span class="sc11">top_left_x</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">static_cast</span><span class="sc10">&lt;</span><span class="sc16">int</span><span class="sc10">&gt;(</span><span class="sc11">current_pos</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0"> </span><span class="sc2">// convert the subpixel value to a proper pixel value (top left pixel due to int() operator)
</span><span class="sc0">            </span><span class="sc11">top_left_y</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">static_cast</span><span class="sc10">&lt;</span><span class="sc16">int</span><span class="sc10">&gt;(</span><span class="sc11">current_pos</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]);</span><span class="sc0">

            </span><span class="sc2">// if the current position exceeeds the panorama image limit -- leave pixel black and skip to next iteration
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">current_pos</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">top_left_x</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">cols</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">current_pos</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">top_left_y</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">rows</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc2">// initialize weights for bilinear interpolation
</span><span class="sc0">            </span><span class="sc11">dx</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current_pos</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">top_left_x</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">dy</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">current_pos</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">top_left_y</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">wtl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1.0</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1.0</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">dy</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">wtr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1.0</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">dy</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">wbl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1.0</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">dy</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">wbr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">dx</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">dy</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc2">// determine subpixel value with bilinear interpolation
</span><span class="sc0">            </span><span class="sc11">bgr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">wtl</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">&lt;</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec3b</span><span class="sc10">&gt;(</span><span class="sc11">top_left_y</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">top_left_x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">wtr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">&lt;</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec3b</span><span class="sc10">&gt;(</span><span class="sc11">top_left_y</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">top_left_x</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0">
                  </span><span class="sc11">wbl</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">&lt;</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec3b</span><span class="sc10">&gt;(</span><span class="sc11">top_left_y</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">top_left_x</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">wbr</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">img_src</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">&lt;</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec3b</span><span class="sc10">&gt;(</span><span class="sc11">top_left_y</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">top_left_x</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc2">// paint the pixel in the output image with the calculated value
</span><span class="sc0">            </span><span class="sc11">img_dst</span><span class="sc10">.</span><span class="sc11">at</span><span class="sc10">&lt;</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Vec3b</span><span class="sc10">&gt;(</span><span class="sc11">cv</span><span class="sc10">::</span><span class="sc11">Point</span><span class="sc10">(</span><span class="sc11">u</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">v</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">bgr</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span></div></body>
</html>
